---
title: 排障指南
---
本指南将引导您完成对 Hydro 系统问题的诊断和排查。并给出相应的提问指导。

请先确保您已浏览过一遍 [常见问题解答](./index.mdx) 中的内容，以排除常见问题。

## Step 1. 检查进程状态

首先，使用 `pm2 ls` 检查所有服务是否正常运行。一个健康的系统应包含 `hydrooj`, `hydro-sandbox`, `mongodb`, `caddy` 四个在线的（`online`）进程。

```sh
pm2 ls
```

- **正常状态**：所有进程 `status` 均为 `online`，且 `uptime` 在持续增长。
- **异常状态**：任意进程 `status` 不为 `online`，或 `restarts` 次数过多。

## Step 2. 诊断单个进程问题

如果特定进程无法启动，请单独进行诊断。

### 2.1.Caddy 服务

如果 `caddy` 进程无法启动，通常是端口被占用或配置错误。在前台运行 Caddy 以查看详细日志：

```sh
cd ~/.hydro
caddy run
```

日志将明确指出是端口冲突（`address already in use`）还是配置文件 `~/.hydro/Caddyfile` 的语法错误。

#### 2.1.1.端口冲突
如果是端口冲突，请使用以下命令查找占用端口的进程：

```sh
sudo lsof -i :80
sudo lsof -i :443
```
根据输出停止冲突进程。如果您有多个网站需要运行，请使用[反向代理配置](../install/proxy)同时配置多个站点，而不是使用多个 Web 服务器实例。

#### 2.1.2.配置错误
如果是配置文件错误，请根据日志提示修改 `~/.hydro/Caddyfile` 。如果不确定如何修改，可以[截图完整日志]()发送到群里寻求帮助。
### hydro-sandbox 服务

如果 `hydro-sandbox` 无法启动，通常与系统权限或内核版本有关。使用以下命令查看日志：

```sh
pm2 logs hydro-sandbox --lines 100
```

日志中的错误信息（如 `permission denied`）将有助于定位问题。如果不确定如何解决，可以[截图完整日志]()发送到群里寻求帮助。

## Step 3. 诊断 Hydro 主服务

如果 `hydrooj` 进程无法启动或启动后系统功能异常，请遵循以下步骤排查。
1. **更新到最新版本**：确保您的 Hydro 系统是最新版本，许多已知问题在后续版本中都已修复。
2. **前台运行**：关闭 pm2 中的进程并直接在前台启动，以获取实时的、完整的日志输出。

   ```sh
   pm2 stop hydrooj
   hydrooj
   ```
3. **隔离插件问题**：第三方插件是常见的故障原因。首先备份并禁用所有非官方插件。

   ```sh
   # 备份插件配置文件
   cp ~/.hydro/addon.json ~/.hydro/addon.json.bak
   # 查看插件列表
   hydrooj addon list
   # 逐个禁用所有不含 @hydrooj/ 前缀的插件
   hydrooj addon remove <plugin_name>
   ```
4. **重启服务**：禁用插件后，重新启动 Hydro 服务检查问题是否解决。
5. **定位问题插件**：如果禁用插件后系统恢复正常，逐个重新启用它们，直到找到导致问题的插件，并联系其开发者解决。
6. **寻求帮助**：如果以上步骤均无法解决问题，请在群里提供自 Hydro 服务启动到触发故障的[完整日志截图 / 日志文件]()，以便于我们诊断问题。

## Step 4. 诊断前端异常

前端异常通常表现为页面卡在加载动画（转圈）或浏览器左下角出现黄色/红色的错误提示。

1. **清除缓存**：使用 `Ctrl+Shift+Delete` 强制清除浏览器缓存和 `Service Worker`，然后刷新页面。
2. **更新浏览器**：确保您正在使用最新版本的现代浏览器（如 Chrome）。
3. **隔离插件问题**：参照 [Step 3](#step-3-诊断-hydro-主服务) 中的方法，检查是否由第三方插件的前端部分引起。
4. **使用开发者工具**：

   - 按 `F12` 打开开发者工具，切换到 `Console`（控制台）标签页，检查是否有红色的报错信息。
   - 切换到 `Network`（网络）标签页，刷新页面，检查是否有请求失败（状态码为 4xx 或 5xx）。
5. **寻求帮助**：加群反馈，并附上 `Console` 和 `Network` 标签页的[完整截图]()。
